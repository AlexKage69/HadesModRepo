From 7f9571893b5e954f73ee314bdd3d078e404d490b Mon Sep 17 00:00:00 2001
From: PonyWarrior
Date: Thu, 13 Feb 2020 20:19:50 +0800
Subject: [PATCH] CodexMenu

---
 CodexMenuData.lua    |   4 +
 CodexMenuScripts.lua | 208 +++++++++++++++++++++++++++++++++++++++++++
 RoomManager.lua      |   4 +-
 TraitScripts.lua     |   1 +
 4 files changed, 216 insertions(+), 1 deletion(-)
 create mode 100644 CodexMenuData.lua
 create mode 100644 CodexMenuScripts.lua

diff --git a/CodexMenuData.lua b/CodexMenuData.lua
new file mode 100644
index 0000000..5922ef2
--- /dev/null
+++ b/CodexMenuData.lua
@@ -0,0 +1,4 @@
+CodexMenuData =
+{
+  LastAddedTrait = nil
+}
diff --git a/CodexMenuScripts.lua b/CodexMenuScripts.lua
new file mode 100644
index 0000000..fe75cbb
--- /dev/null
+++ b/CodexMenuScripts.lua
@@ -0,0 +1,208 @@
+function RemoveAllTraits()
+	-- Remove all traits
+	local removedTraitData = {}
+	for i, traitData in pairs( CurrentRun.Hero.Traits ) do
+		table.insert(removedTraitData, { Name = traitData.Name, Rarity = traitData.Rarity })
+	end
+
+	for i, traitData in pairs(removedTraitData) do
+		RemoveTrait( CurrentRun.Hero, traitData.Name )
+	end
+	--Reload equipment
+	EquipWeaponUpgrade(CurrentRun.Hero)
+	UnequipKeepsake(CurrentRun.Hero)
+	EquipKeepsake(CurrentRun.Hero)
+	UnequipAssist(CurrentRun.Hero)
+	EquipAssist(CurrentRun.Hero)
+end
+
+function ModDebugPrint(text, delay)
+	if delay == nil then
+		delay = 5
+	end
+	Destroy({Ids = ScreenAnchors.HoldDisplayId})
+	ScreenAnchors.HoldDisplayId = SpawnObstacle({ Name = "BlankObstacle", Group = "Events", DestinationId = CurrentRun.Hero.ObjectId })
+	Attach({ Id = ScreenAnchors.HoldDisplayId, DestinationId = CurrentRun.Hero.ObjectId })
+	CreateTextBox({ Id = ScreenAnchors.HoldDisplayId, Text = text, FontSize = 32, OffsetX = 0, OffsetY = -150, Color = Color.Yellow, Font = "AlegreyaSansSCBold", Justification = "Center" })
+	wait(delay, RoomThreadName)
+	Destroy({Ids = ScreenAnchors.HoldDisplayId})
+	ScreenAnchors.HoldDisplayId = nil
+end
+
+OnControlPressed{ "Codex",
+	function( triggerArgs )
+		if CodexUI.Screen == nil then
+			return
+		end
+		-- prevent crash by pressing too early
+		wait(0.5)
+		--set to false for public version
+		local debug = false
+		--Boons
+		if CodexStatus.SelectedChapterName == "OlympianGods" then
+			local boon = CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName]
+			CreateLoot({ Name = boon, OffsetX = 100, SpawnPoint = CurrentRun.Hero.ObjectId })
+			if debug then
+				ModDebugPrint("Trying to spawn boon : " .. boon)
+			end
+			return
+		end
+		--Chaos Boon
+		if CodexStatus.SelectedChapterName == "ChthonicGods" and
+		 CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName] == "TrialUpgrade" then
+			local boon = CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName]
+			CreateLoot({ Name = boon, OffsetX = 100, SpawnPoint = CurrentRun.Hero.ObjectId })
+			if debug then
+				ModDebugPrint("Trying to spawn boon : " .. boon)
+			end
+			return
+		end
+		--Items
+		if CodexStatus.SelectedChapterName == "Items" then
+			local consumableTable =
+			{
+				["RoomRewardMetaPointDrop"] = "RoomRewardMetaPointDrop",
+				["GemDrop"] = "GemDrop",
+				["LockKeyDrop"] = "LockKeyDrop",
+				["GiftDrop"] = "GiftDrop",
+				["RoomRewardMaxHealthDrop"] = "RoomRewardMaxHealthDrop",
+				["RoomRewardMoneyDrop"] = "RoomRewardMoneyDrop",
+				["SuperGemDrop"] = "SuperGemDrop",
+				["SuperLockKeyDrop"] = "SuperLockKeyDrop",
+				["SuperGiftDrop"] = "SuperGiftDrop",
+				["RoomRewardConsolationPrize"] = "RoomRewardConsolationPrize",
+			}
+			local item = CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName]
+			if item == consumableTable[item] then
+        local consumableId = SpawnObstacle({ Name = item, DestinationId = CurrentRun.Hero.ObjectId, Group = "Standing", OffsetX = 100 })
+        local cost = 0
+        local consumable = CreateConsumableItem( consumableId, item, cost )
+				if debug then
+					ModDebugPrint("Trying to spawn consumable : " .. item)
+				end
+				return
+			end
+			CreateLoot({ Name = item, OffsetX = 100, SpawnPoint = CurrentRun.Hero.ObjectId })
+			if debug then
+				ModDebugPrint("Trying to spawn item : " .. item)
+			end
+			return
+		end
+		--Weapons
+		if CodexStatus.SelectedChapterName == "Weapons" then
+			local weapon = CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName]
+			EquipPlayerWeapon( WeaponData[weapon], { PreLoadBinks = true } )
+			RemoveAllTraits()
+			if debug then
+				ModDebugPrint("Trying to equip weapon : " .. weapon)
+			end
+			return
+		end
+		--Enemies
+		if CodexStatus.SelectedChapterName == "Enemies" then
+			local enemy = CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName]
+			local enemyData = EnemyData[enemy]
+			local newEnemy = DeepCopyTable( enemyData )
+			newEnemy.AIOptions = enemyData.AIOptions
+			newEnemy.BlocksLootInteraction = false
+			local invaderSpawnPoint = 40000
+			newEnemy.ObjectId = SpawnUnit({
+					Name = enemyData.Name,
+					Group = "Standing",
+					DestinationId = invaderSpawnPoint, OffsetX = 400, OffsetY = 200 })
+			SetupEnemyObject( newEnemy, CurrentRun )
+			if debug then
+				ModDebugPrint("Trying to spawn enemy : " .. enemy)
+			end
+			return
+		end
+		--Bosses and Commands
+		if CodexStatus.SelectedChapterName == "ChthonicGods" or
+		CodexStatus.SelectedChapterName == "OtherDenizens" then
+			local debugTicks = 0
+			local entry = CodexStatus.SelectedEntryNames[CodexStatus.SelectedChapterName]
+			local bossTable =
+			{
+				["NPC_Hades_01"] = "Hades",
+				["NPC_FurySister_01"] = "Harpy",
+				["Harpy2"] = "Harpy2",
+				["Harpy3"] = "Harpy3",
+				["Theseus"] = "Theseus",
+				["Minotaur"] = "Minotaur",
+				["NPC_Thanatos_01"] = "NPC_Thanatos_Field_01"
+			}
+			local commandTable =
+			{
+				["PlayerUnit"] = function()
+					RemoveAllTraits()
+				end,
+				["NPC_Achilles_01"] = function()
+					if IsSuperValid() then
+						wait(1, RoomThreadName)
+						BuildSuperMeter(CurrentRun, 100)
+						CommenceSuperMove()
+						UpdateSuperDamageBonus()
+						thread( MarkObjectiveComplete, "EXMove" )
+					end
+				end,
+				["NPC_Nyx_01"] = function()
+					OpenMetaUpgradeMenu()
+				end,
+				["NPC_Skelly_01"] = function()
+					OpenShrineUpgradeMenu({ BlockRunStartButton = true })
+				end,
+				["NPC_Cerberus_01"] = function()
+					StartUpAwardMenu(triggerArgs.TriggeredByTable)
+				end,
+				["NPC_Charon_01"] = function()
+					CurrentRun.CurrentRoom.Store = nil
+					StartUpStore()
+				end,
+				["NPC_Hypnos_01"] = function()
+					GenerateSellTraitShop(CurrentRun, CurrentRun.CurrentRoom)
+					OpenSellTraitMenu()
+				end,
+				["NPC_Orpheus_01"] = function()
+					if CodexMenuData.LastAddedTrait ~= nil then
+						RemoveTrait(CurrentRun.Hero, CodexMenuData.LastAddedTrait)
+					end
+				end,
+				["NPC_Eurydice_01"] = function()
+					for i, traitData in pairs( CurrentRun.Hero.Traits ) do
+						if CodexMenuData.LastAddedTrait ~= nil and traitData.Name == CodexMenuData.LastAddedTrait and TraitData[traitData.Name] and traitData.Rarity ~= nil and GetUpgradedRarity(traitData.Rarity) ~= nil and traitData.RarityLevels[GetUpgradedRarity(traitData.Rarity)] ~= nil then
+							RemoveWeaponTrait( traitData.Name )
+							AddTraitToHero({ TraitData = GetProcessedTraitData({ Unit = CurrentRun.Hero, TraitName = traitData.Name, Rarity = GetUpgradedRarity(traitData.Rarity) }) })
+						end
+					end
+				end,
+			}
+			--Bosses
+			if bossTable[entry] then
+				if entry == "NPC_Hades_01" then entry = "Hades"
+				elseif entry == "NPC_FurySister_01" then entry = "Harpy"
+				elseif entry == "NPC_Thanatos_01" then entry = "NPC_Thanatos_Field_01"
+				end
+				local enemyData = EnemyData[entry]
+				local newEnemy = DeepCopyTable( enemyData )
+				newEnemy.AIOptions = enemyData.AIOptions
+				newEnemy.BlocksLootInteraction = false
+				local invaderSpawnPoint = 40000
+				newEnemy.ObjectId = SpawnUnit({
+						Name = enemyData.Name,
+						Group = "Standing",
+						DestinationId = invaderSpawnPoint, OffsetX = 400, OffsetY = 200 })
+				SetupEnemyObject( newEnemy, CurrentRun )
+				if debug then
+					ModDebugPrint("Trying to spawn boss : " .. entry)
+				end
+				--Commands
+			elseif commandTable[entry] then
+				commandTable[entry]()
+				if debug then
+					ModDebugPrint("Trying to use command : " .. entry)
+				end
+			end
+			return
+		end
+	end
+}
diff --git a/RoomManager.lua b/RoomManager.lua
index 12a6a98..ac9f2be 100644
--- a/RoomManager.lua
+++ b/RoomManager.lua
@@ -16,7 +16,9 @@ Import "CodexScripts.lua"
 Import "UtilityScripts.lua"
 Import "DebugScripts.lua"
 Import "PlayerAIData.lua"
-
+--Codex Menu
+Import "CodexMenuScripts.lua"
+Import "CodexMenuData.lua"
 Import "Art.lua"
 Import "EnemyAI.lua"
 Import "UpgradeManager.lua"
diff --git a/TraitScripts.lua b/TraitScripts.lua
index 1c451e6..426d290 100644
--- a/TraitScripts.lua
+++ b/TraitScripts.lua
@@ -511,6 +511,7 @@ function AddTraitToHero(args)
 	-- traits may have information that acts on weapons, so we must first equip all associated weapons to the player
 	EquipReferencedWeapons( traitData )
 	AddTraitData( CurrentRun.Hero, traitData, args )

+	CodexMenuData.LastAddedTrait = traitData.Name --Codex Menu
 	EquipSpecialWeapons( CurrentRun.Hero, traitData )
 	AddAssistWeapons( CurrentRun.Hero, traitData )
 	for weaponName, v in pairs( CurrentRun.Hero.Weapons ) do
--
2.25.0.windows.1
